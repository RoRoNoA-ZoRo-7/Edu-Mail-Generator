name: Paper Minecraft Server with Ngrok

on:
  workflow_dispatch:

jobs:
  run-minecraft:
    runs-on: ubuntu-latest

    steps:
    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'

    - name: Install Ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok -y

    - name: Authenticate Ngrok
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        ngrok config add-authtoken $NGROK_AUTH_TOKEN

    - name: Download and Set Up Paper Server
      run: |
        mkdir server
        cd server
        curl -o paper.jar https://api.papermc.io/v2/projects/paper/versions/1.20.3/builds/463/downloads/paper-1.20.3-463.jar
        echo "eula=true" > eula.txt

    - name: Start Minecraft Server and Ngrok Tunnel
      run: |
        cd server
        # Start Minecraft server in the background
        java -Xmx1G -Xms1G -jar paper.jar nogui &
        sleep 20
        # Start Ngrok TCP tunnel on port 25565
        ngrok tcp 25565 > ../ngrok.log &
        sleep 10

    - name: Get Ngrok Public Address
      run: |
        curl -s http://127.0.0.1:4040/api/tunnels > tunnels.json
        cat tunnels.json

    - name: Extract and Display Ngrok TCP Address
      run: |
        echo "Minecraft Server is online! IP and Port:"
        # Extract the public TCP address
        addr=$(jq -r '.tunnels[0].public_url' < tunnels.json)
        echo "Connect using: $addr"
